# ✅ Miniconda 베이스 이미지
FROM continuumio/miniconda3:24.1.2-0

# 작업 디렉토리 설정
WORKDIR /app

# environment.yml 복사
COPY environment.yml /app/

# Conda 환경 생성 및 활성화
RUN conda env create -f environment.yml

# conda 환경 활성화 후 기본 실행환경으로 설정
SHELL ["conda", "run", "-n", "inpick-fastapi", "/bin/bash", "-c"]

# 소스코드 복사
COPY . /app

# FastAPI 실행 포트
EXPOSE 8000

# 실행 커맨드 (Gunicorn + Uvicorn Worker)
CMD ["conda", "run", "--no-capture-output", "-n", "inpick-fastapi", \
     "gunicorn", "-k", "uvicorn.workers.UvicornWorker", "main:app", \
     "--bind", "0.0.0.0:8000", "--workers", "4"]